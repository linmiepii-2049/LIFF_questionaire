<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF 狀態測試</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .status.success { border-left-color: #4CAF50; background-color: #E8F5E8; }
        .status.error { border-left-color: #f44336; background-color: #FFEBEE; }
        .status.info { border-left-color: #2196F3; background-color: #E3F2FD; }
        .status.warning { border-left-color: #ff9800; background-color: #FFF3E0; }
        
        button {
            background: #00B900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #009900; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .profile-info {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .profile-info h3 { margin-top: 0; color: #2E7D32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 LIFF 狀態測試工具</h1>
        <p>這個頁面用來測試 LIFF 的各種狀態和功能</p>
        
        <div class="status info">
            <strong>📱 當前環境：</strong>
            <span id="environment">檢測中...</span>
        </div>
        
        <div class="status info">
            <strong>🔑 LIFF ID：</strong>
            <span id="liffId">未設定</span>
        </div>
        
        <div class="status info">
            <strong>📊 LIFF 狀態：</strong>
            <span id="liffStatus">未初始化</span>
        </div>
        
        <div class="status info">
            <strong>👤 用戶狀態：</strong>
            <span id="userStatus">未檢查</span>
        </div>
        
        <div id="profileInfo" class="profile-info" style="display: none;">
            <h3>👤 用戶資料</h3>
            <div id="profileDetails"></div>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="checkLiffStatus()">🔄 檢查 LIFF 狀態</button>
            <button onclick="initLiff()">🚀 初始化 LIFF</button>
            <button onclick="loginUser()" id="loginBtn" disabled>🔐 登入用戶</button>
            <button onclick="getProfile()" id="profileBtn" disabled>👤 獲取用戶資料</button>
            <button onclick="clearLog()">🗑️ 清除日誌</button>
        </div>
        
        <h3>📋 操作日誌</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let liffInitialized = false;
        
        // 日誌功能
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#f44336' : 
                                  type === 'success' ? '#4CAF50' : 
                                  type === 'warning' ? '#ff9800' : '#2196F3';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 更新狀態顯示
        function updateStatus(elementId, text, className = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = className;
        }
        
        // 檢查 LIFF 狀態
        function checkLiffStatus() {
            log('🔍 開始檢查 LIFF 狀態...');
            
            // 檢查 LIFF SDK 是否載入
            if (typeof liff === 'undefined') {
                updateStatus('liffStatus', '❌ LIFF SDK 未載入', 'error');
                log('❌ LIFF SDK 未載入', 'error');
                return;
            }
            
            // 檢查 LIFF 是否已初始化
            try {
                if (liffInitialized) {
                    updateStatus('liffStatus', '✅ LIFF 已初始化', 'success');
                    log('✅ LIFF 已初始化', 'success');
                    
                    // 檢查登入狀態
                    const isLoggedIn = liff.isLoggedIn();
                    const isInClient = liff.isInClient();
                    
                    updateStatus('userStatus', 
                        `${isLoggedIn ? '✅ 已登入' : '❌ 未登入'} | ${isInClient ? '📱 LINE App內' : '🌐 外部瀏覽器'}`, 
                        isLoggedIn ? 'success' : 'warning'
                    );
                    
                    log(`用戶狀態：${isLoggedIn ? '已登入' : '未登入'}, 環境：${isInClient ? 'LINE App內' : '外部瀏覽器'}`);
                    
                    // 更新按鈕狀態
                    document.getElementById('loginBtn').disabled = isLoggedIn;
                    document.getElementById('profileBtn').disabled = !isLoggedIn;
                    
                } else {
                    updateStatus('liffStatus', '❌ LIFF 未初始化', 'error');
                    log('❌ LIFF 未初始化', 'error');
                }
            } catch (error) {
                updateStatus('liffStatus', '❌ 檢查失敗', 'error');
                log(`❌ 檢查 LIFF 狀態失敗：${error.message}`, 'error');
            }
        }
        
        // 初始化 LIFF
        async function initLiff() {
            log('🚀 開始初始化 LIFF...');
            
            try {
                // 先獲取 LIFF 配置
                const response = await fetch('https://liff-survey-worker.survey-api.workers.dev/api/config');
                const config = await response.json();
                
                if (config.success && config.data.liffId) {
                    updateStatus('liffId', config.data.liffId, 'success');
                    log(`✅ 獲取到 LIFF ID：${config.data.liffId}`);
                    
                    // 初始化 LIFF
                    await liff.init({
                        liffId: config.data.liffId,
                        scope: 'profile openid'
                    });
                    
                    liffInitialized = true;
                    updateStatus('liffStatus', '✅ LIFF 初始化成功', 'success');
                    log('✅ LIFF 初始化成功');
                    
                    // 檢查環境
                    const isInClient = liff.isInClient();
                    updateStatus('environment', 
                        isInClient ? '📱 LINE App內' : '🌐 外部瀏覽器', 
                        isInClient ? 'success' : 'warning'
                    );
                    
                    // 檢查登入狀態
                    const isLoggedIn = liff.isLoggedIn();
                    updateStatus('userStatus', 
                        `${isLoggedIn ? '✅ 已登入' : '❌ 未登入'} | ${isInClient ? '📱 LINE App內' : '🌐 外部瀏覽器'}`, 
                        isLoggedIn ? 'success' : 'warning'
                    );
                    
                    log(`環境：${isInClient ? 'LINE App內' : '外部瀏覽器'}`);
                    log(`登入狀態：${isLoggedIn ? '已登入' : '未登入'}`);
                    
                    // 更新按鈕狀態
                    document.getElementById('loginBtn').disabled = isLoggedIn;
                    document.getElementById('profileBtn').disabled = !isLoggedIn;
                    
                    if (!isLoggedIn) {
                        log('⚠️ 用戶未登入，建議點擊登入按鈕', 'warning');
                    }
                    
                } else {
                    updateStatus('liffId', '❌ 無法獲取 LIFF ID', 'error');
                    log('❌ 無法獲取 LIFF 配置', 'error');
                }
                
            } catch (error) {
                updateStatus('liffStatus', '❌ 初始化失敗', 'error');
                log(`❌ LIFF 初始化失敗：${error.message}`, 'error');
            }
        }
        
        // 登入用戶
        async function loginUser() {
            log('🔐 開始登入流程...');
            
            try {
                if (!liffInitialized) {
                    log('❌ LIFF 未初始化，無法登入', 'error');
                    return;
                }
                
                if (liff.isLoggedIn()) {
                    log('✅ 用戶已經登入', 'success');
                    return;
                }
                
                // 執行登入
                liff.login();
                log('🔄 已觸發登入流程，請在彈出的視窗中授權');
                
            } catch (error) {
                log(`❌ 登入失敗：${error.message}`, 'error');
            }
        }
        
        // 獲取用戶資料
        async function getProfile() {
            log('👤 開始獲取用戶資料...');
            
            try {
                if (!liffInitialized) {
                    log('❌ LIFF 未初始化', 'error');
                    return;
                }
                
                if (!liff.isLoggedIn()) {
                    log('❌ 用戶未登入，無法獲取資料', 'error');
                    return;
                }
                
                const profile = await liff.getProfile();
                log('✅ 成功獲取用戶資料', 'success');
                log(`用戶資料：${JSON.stringify(profile, null, 2)}`);
                
                // 顯示用戶資料
                document.getElementById('profileInfo').style.display = 'block';
                document.getElementById('profileDetails').innerHTML = `
                    <p><strong>用戶 ID：</strong>${profile.userId}</p>
                    <p><strong>顯示名稱：</strong>${profile.displayName}</p>
                    <p><strong>狀態訊息：</strong>${profile.statusMessage || '無'}</p>
                    <p><strong>大頭貼：</strong>${profile.pictureUrl ? `<img src="${profile.pictureUrl}" style="width: 50px; height: 50px; border-radius: 50%;">` : '無'}</p>
                `;
                
                updateStatus('userStatus', '✅ 已登入 | 資料已獲取', 'success');
                
            } catch (error) {
                log(`❌ 獲取用戶資料失敗：${error.message}`, 'error');
            }
        }
        
        // 頁面載入時自動檢查
        window.addEventListener('load', () => {
            log('📱 頁面載入完成，開始檢查 LIFF 狀態...');
            checkLiffStatus();
        });
        
        // 定期檢查狀態（每5秒）
        setInterval(() => {
            if (liffInitialized) {
                checkLiffStatus();
            }
        }, 5000);
    </script>
</body>
</html> 