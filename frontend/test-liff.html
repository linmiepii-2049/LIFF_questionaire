<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF ç‹€æ…‹æ¸¬è©¦</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .status.success { border-left-color: #4CAF50; background-color: #E8F5E8; }
        .status.error { border-left-color: #f44336; background-color: #FFEBEE; }
        .status.info { border-left-color: #2196F3; background-color: #E3F2FD; }
        .status.warning { border-left-color: #ff9800; background-color: #FFF3E0; }
        
        button {
            background: #00B900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #009900; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .profile-info {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .profile-info h3 { margin-top: 0; color: #2E7D32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LIFF ç‹€æ…‹æ¸¬è©¦å·¥å…·</h1>
        <p>é€™å€‹é é¢ç”¨ä¾†æ¸¬è©¦ LIFF çš„å„ç¨®ç‹€æ…‹å’ŒåŠŸèƒ½</p>
        
        <div class="status info">
            <strong>ğŸ“± ç•¶å‰ç’°å¢ƒï¼š</strong>
            <span id="environment">æª¢æ¸¬ä¸­...</span>
        </div>
        
        <div class="status info">
            <strong>ğŸ”‘ LIFF IDï¼š</strong>
            <span id="liffId">æœªè¨­å®š</span>
        </div>
        
        <div class="status info">
            <strong>ğŸ“Š LIFF ç‹€æ…‹ï¼š</strong>
            <span id="liffStatus">æœªåˆå§‹åŒ–</span>
        </div>
        
        <div class="status info">
            <strong>ğŸ‘¤ ç”¨æˆ¶ç‹€æ…‹ï¼š</strong>
            <span id="userStatus">æœªæª¢æŸ¥</span>
        </div>
        
        <div id="profileInfo" class="profile-info" style="display: none;">
            <h3>ğŸ‘¤ ç”¨æˆ¶è³‡æ–™</h3>
            <div id="profileDetails"></div>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="checkLiffStatus()">ğŸ”„ æª¢æŸ¥ LIFF ç‹€æ…‹</button>
            <button onclick="initLiff()">ğŸš€ åˆå§‹åŒ– LIFF</button>
            <button onclick="loginUser()" id="loginBtn" disabled>ğŸ” ç™»å…¥ç”¨æˆ¶</button>
            <button onclick="getProfile()" id="profileBtn" disabled>ğŸ‘¤ ç²å–ç”¨æˆ¶è³‡æ–™</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        </div>
        
        <h3>ğŸ“‹ æ“ä½œæ—¥èªŒ</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let liffInitialized = false;
        
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#f44336' : 
                                  type === 'success' ? '#4CAF50' : 
                                  type === 'warning' ? '#ff9800' : '#2196F3';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(elementId, text, className = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = className;
        }
        
        // æª¢æŸ¥ LIFF ç‹€æ…‹
        function checkLiffStatus() {
            log('ğŸ” é–‹å§‹æª¢æŸ¥ LIFF ç‹€æ…‹...');
            
            // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
            if (typeof liff === 'undefined') {
                updateStatus('liffStatus', 'âŒ LIFF SDK æœªè¼‰å…¥', 'error');
                log('âŒ LIFF SDK æœªè¼‰å…¥', 'error');
                return;
            }
            
            // æª¢æŸ¥ LIFF æ˜¯å¦å·²åˆå§‹åŒ–
            try {
                if (liffInitialized) {
                    updateStatus('liffStatus', 'âœ… LIFF å·²åˆå§‹åŒ–', 'success');
                    log('âœ… LIFF å·²åˆå§‹åŒ–', 'success');
                    
                    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                    const isLoggedIn = liff.isLoggedIn();
                    const isInClient = liff.isInClient();
                    
                    updateStatus('userStatus', 
                        `${isLoggedIn ? 'âœ… å·²ç™»å…¥' : 'âŒ æœªç™»å…¥'} | ${isInClient ? 'ğŸ“± LINE Appå…§' : 'ğŸŒ å¤–éƒ¨ç€è¦½å™¨'}`, 
                        isLoggedIn ? 'success' : 'warning'
                    );
                    
                    log(`ç”¨æˆ¶ç‹€æ…‹ï¼š${isLoggedIn ? 'å·²ç™»å…¥' : 'æœªç™»å…¥'}, ç’°å¢ƒï¼š${isInClient ? 'LINE Appå…§' : 'å¤–éƒ¨ç€è¦½å™¨'}`);
                    
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('loginBtn').disabled = isLoggedIn;
                    document.getElementById('profileBtn').disabled = !isLoggedIn;
                    
                } else {
                    updateStatus('liffStatus', 'âŒ LIFF æœªåˆå§‹åŒ–', 'error');
                    log('âŒ LIFF æœªåˆå§‹åŒ–', 'error');
                }
            } catch (error) {
                updateStatus('liffStatus', 'âŒ æª¢æŸ¥å¤±æ•—', 'error');
                log(`âŒ æª¢æŸ¥ LIFF ç‹€æ…‹å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }
        
        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
            
            try {
                // å…ˆç²å– LIFF é…ç½®
                const response = await fetch('https://liff-survey-worker.survey-api.workers.dev/api/config');
                const config = await response.json();
                
                if (config.success && config.data.liffId) {
                    updateStatus('liffId', config.data.liffId, 'success');
                    log(`âœ… ç²å–åˆ° LIFF IDï¼š${config.data.liffId}`);
                    
                    // åˆå§‹åŒ– LIFF
                    await liff.init({
                        liffId: config.data.liffId,
                        scope: 'profile openid'
                    });
                    
                    liffInitialized = true;
                    updateStatus('liffStatus', 'âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');
                    log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
                    
                    // æª¢æŸ¥ç’°å¢ƒ
                    const isInClient = liff.isInClient();
                    updateStatus('environment', 
                        isInClient ? 'ğŸ“± LINE Appå…§' : 'ğŸŒ å¤–éƒ¨ç€è¦½å™¨', 
                        isInClient ? 'success' : 'warning'
                    );
                    
                    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                    const isLoggedIn = liff.isLoggedIn();
                    updateStatus('userStatus', 
                        `${isLoggedIn ? 'âœ… å·²ç™»å…¥' : 'âŒ æœªç™»å…¥'} | ${isInClient ? 'ğŸ“± LINE Appå…§' : 'ğŸŒ å¤–éƒ¨ç€è¦½å™¨'}`, 
                        isLoggedIn ? 'success' : 'warning'
                    );
                    
                    log(`ç’°å¢ƒï¼š${isInClient ? 'LINE Appå…§' : 'å¤–éƒ¨ç€è¦½å™¨'}`);
                    log(`ç™»å…¥ç‹€æ…‹ï¼š${isLoggedIn ? 'å·²ç™»å…¥' : 'æœªç™»å…¥'}`);
                    
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    document.getElementById('loginBtn').disabled = isLoggedIn;
                    document.getElementById('profileBtn').disabled = !isLoggedIn;
                    
                    if (!isLoggedIn) {
                        log('âš ï¸ ç”¨æˆ¶æœªç™»å…¥ï¼Œå»ºè­°é»æ“Šç™»å…¥æŒ‰éˆ•', 'warning');
                    }
                    
                } else {
                    updateStatus('liffId', 'âŒ ç„¡æ³•ç²å– LIFF ID', 'error');
                    log('âŒ ç„¡æ³•ç²å– LIFF é…ç½®', 'error');
                }
                
            } catch (error) {
                updateStatus('liffStatus', 'âŒ åˆå§‹åŒ–å¤±æ•—', 'error');
                log(`âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }
        
        // ç™»å…¥ç”¨æˆ¶
        async function loginUser() {
            log('ğŸ” é–‹å§‹ç™»å…¥æµç¨‹...');
            
            try {
                if (!liffInitialized) {
                    log('âŒ LIFF æœªåˆå§‹åŒ–ï¼Œç„¡æ³•ç™»å…¥', 'error');
                    return;
                }
                
                if (liff.isLoggedIn()) {
                    log('âœ… ç”¨æˆ¶å·²ç¶“ç™»å…¥', 'success');
                    return;
                }
                
                // åŸ·è¡Œç™»å…¥
                liff.login();
                log('ğŸ”„ å·²è§¸ç™¼ç™»å…¥æµç¨‹ï¼Œè«‹åœ¨å½ˆå‡ºçš„è¦–çª—ä¸­æˆæ¬Š');
                
            } catch (error) {
                log(`âŒ ç™»å…¥å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }
        
        // ç²å–ç”¨æˆ¶è³‡æ–™
        async function getProfile() {
            log('ğŸ‘¤ é–‹å§‹ç²å–ç”¨æˆ¶è³‡æ–™...');
            
            try {
                if (!liffInitialized) {
                    log('âŒ LIFF æœªåˆå§‹åŒ–', 'error');
                    return;
                }
                
                if (!liff.isLoggedIn()) {
                    log('âŒ ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•ç²å–è³‡æ–™', 'error');
                    return;
                }
                
                const profile = await liff.getProfile();
                log('âœ… æˆåŠŸç²å–ç”¨æˆ¶è³‡æ–™', 'success');
                log(`ç”¨æˆ¶è³‡æ–™ï¼š${JSON.stringify(profile, null, 2)}`);
                
                // é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
                document.getElementById('profileInfo').style.display = 'block';
                document.getElementById('profileDetails').innerHTML = `
                    <p><strong>ç”¨æˆ¶ IDï¼š</strong>${profile.userId}</p>
                    <p><strong>é¡¯ç¤ºåç¨±ï¼š</strong>${profile.displayName}</p>
                    <p><strong>ç‹€æ…‹è¨Šæ¯ï¼š</strong>${profile.statusMessage || 'ç„¡'}</p>
                    <p><strong>å¤§é ­è²¼ï¼š</strong>${profile.pictureUrl ? `<img src="${profile.pictureUrl}" style="width: 50px; height: 50px; border-radius: 50%;">` : 'ç„¡'}</p>
                `;
                
                updateStatus('userStatus', 'âœ… å·²ç™»å…¥ | è³‡æ–™å·²ç²å–', 'success');
                
            } catch (error) {
                log(`âŒ ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            log('ğŸ“± é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥ LIFF ç‹€æ…‹...');
            checkLiffStatus();
        });
        
        // å®šæœŸæª¢æŸ¥ç‹€æ…‹ï¼ˆæ¯5ç§’ï¼‰
        setInterval(() => {
            if (liffInitialized) {
                checkLiffStatus();
            }
        }, 5000);
    </script>
</body>
</html> 